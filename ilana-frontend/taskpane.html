<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ilana Protocol Intelligence</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        /* Professional taskpane design system */
        
        :root {
            --primary-green: #11a683;
            --primary-green-hover: #15c894;
            --primary-red: #ea1537;
            --primary-red-hover: #f23452;
            --primary-blue: #3b82f6;
            --primary-orange: #f59e0b;
            --text-gray: #8189a9;
            --text-dark: #0e101a;
            --background-light: #f0f2fc;
            --border-light: #e4e6f2;
            --surface-white: #ffffff;
            --surface-hover: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--surface-white);
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
        }

        /* Main sidebar wrapper */
        .sidebar-wrapper {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .wrapper {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header wrapper */
        .header-wrapper {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .lens-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .header-btn {
            background: var(--primary-green);
            color: var(--surface-white);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .header-btn:hover {
            background: var(--primary-green-hover);
        }

        .header-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Navigation container */
        .navigation-container {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
            background: var(--background-light);
        }

        .all-alerts-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .all-alerts-stats {
            color: var(--text-gray);
            font-size: 13px;
        }

        .counter-wrapper {
            display: flex;
            gap: 16px;
        }

        .counter-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .counter-number {
            background: var(--primary-red);
            color: var(--surface-white);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .counter-number.low {
            background: var(--text-gray);
        }

        .counter-number.medium {
            background: var(--primary-orange);
        }

        /* Scroll content */
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .card-wrapper {
            border-bottom: 1px solid var(--border-light);
        }

        .card-wrapper:last-child {
            border-bottom: none;
        }

        /* Full card structure */
        .full-card {
            padding: 20px;
            background: var(--surface-white);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .full-card:hover {
            background: var(--surface-hover);
        }

        .full-card.maximized {
            background: var(--background-light);
        }

        .card-logo {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--surface-white);
        }

        .card-logo.critical {
            background: var(--primary-red);
        }

        .card-logo.high {
            background: var(--primary-red);
        }

        .card-logo.medium {
            background: var(--primary-orange);
        }

        .card-logo.low {
            background: var(--text-gray);
        }

        /* Report list - suggestion items */
        .report-list {
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .item-original {
            position: relative;
            color: var(--primary-red);
            text-decoration: line-through;
            margin-right: 8px;
            font-weight: 500;
        }

        .item-original:after {
            content: 'â†’';
            color: var(--text-gray);
            margin-left: 8px;
            text-decoration: none;
        }

        .item-insert {
            background: var(--primary-green);
            color: var(--surface-white);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .item-insert:hover {
            background: var(--primary-green-hover);
        }

        .item-remove {
            background: var(--primary-red);
            color: var(--surface-white);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .item-remove:hover {
            background: var(--primary-red-hover);
        }

        /* Full sentence background */
        .full-sentence-background {
            background: var(--background-light);
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            font-style: italic;
            line-height: 1.4;
            color: var(--text-dark);
        }

        .full-sentence-insert {
            color: var(--primary-green);
            font-weight: 600;
        }

        .full-sentence-delete {
            color: var(--primary-red);
            text-decoration: line-through;
            font-weight: 600;
        }

        /* Card footer */
        .card-footer {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .card-footer-btn {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-dark);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card-footer-btn:hover {
            background: var(--surface-hover);
            border-color: var(--text-gray);
        }

        .card-footer-btn.primary {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: var(--surface-white);
        }

        .card-footer-btn.primary:hover {
            background: var(--primary-green-hover);
            border-color: var(--primary-green-hover);
        }

        /* Minimized state */
        .minimized .report-list {
            margin-bottom: 0;
        }

        .minimized .full-sentence-background,
        .minimized .card-footer {
            display: none;
        }

        /* Status indicators */
        .status-indicator {
            padding: 12px 20px;
            text-align: center;
            font-size: 13px;
            background: var(--background-light);
            color: var(--text-gray);
            border-bottom: 1px solid var(--border-light);
        }

        .status-indicator.analyzing {
            color: var(--primary-blue);
        }

        .status-indicator.complete {
            background: var(--primary-green);
            color: var(--surface-white);
        }

        .status-indicator.error {
            background: var(--primary-red);
            color: var(--surface-white);
        }

        /* Loading animation */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Hidden state */
        .hidden {
            display: none;
        }

        /* Empty state */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-gray);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary-green);
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .empty-state-subtitle {
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- Professional sidebar wrapper -->
    <div class="sidebar-wrapper">
        <div class="wrapper">
            <!-- Header wrapper -->
            <div class="header-wrapper">
                <div class="header">
                    <div class="lens-title">Ilana</div>
                    <button id="analyzeButton" class="header-btn" onclick="analyzeProtocol()">
                        Analyze
                    </button>
                </div>
            </div>

            <!-- Status indicator -->
            <div id="statusIndicator" class="status-indicator hidden">
                <span id="statusText"></span>
            </div>

            <!-- Navigation container -->
            <div id="navigationContainer" class="navigation-container hidden">
                <div class="all-alerts-container">
                    <div class="all-alerts-stats">
                        <span id="totalIssues">0 issues found</span>
                    </div>
                    <div class="counter-wrapper">
                        <div class="counter-content">
                            <span class="counter-number" id="criticalCount">0</span>
                            <span>Critical</span>
                        </div>
                        <div class="counter-content">
                            <span class="counter-number medium" id="mediumCount">0</span>
                            <span>Medium</span>
                        </div>
                        <div class="counter-content">
                            <span class="counter-number low" id="lowCount">0</span>
                            <span>Low</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scroll content -->
            <div class="scroll-content">
                <div id="cardsList"></div>
                
                <!-- Empty state -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">âœ“</div>
                    <div class="empty-state-title">Ready to analyze</div>
                    <div class="empty-state-subtitle">Click "Analyze" to check your pharmaceutical protocol for compliance, clarity, and feasibility issues.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pharmaceutical Protocol Analyzer - Professional Interface
        const API_BASE_URL = 'https://ilanalabs-add-in.onrender.com';
        let currentIssues = [];
        let maximizedCard = null;

        // Initialize Office.js
        Office.onReady(() => {
            console.log('ðŸš€ Ilana Protocol Intelligence loaded');
            updateStatus('Ready to analyze pharmaceutical protocols', 'complete');
        });

        // Main analysis function
        async function analyzeProtocol() {
            const analyzeButton = document.getElementById('analyzeButton');

            try {
                // Update UI to analyzing state
                analyzeButton.disabled = true;
                analyzeButton.textContent = 'Analyzing...';
                updateStatus('Extracting protocol text<span class="loading-dots"></span>', 'analyzing');
                hideEmptyState();

                // Extract text from Word document
                await Word.run(async (context) => {
                    const body = context.document.body;
                    context.load(body, 'text');
                    await context.sync();

                    const documentText = body.text;
                    
                    if (documentText.length < 10) {
                        throw new Error('Document appears to be empty or too short for analysis');
                    }

                    updateStatus(`Analyzing ${documentText.length.toLocaleString()} characters with Enterprise AI<span class="loading-dots"></span>`, 'analyzing');

                    // Send to API for analysis
                    const response = await fetch(`${API_BASE_URL}/analyze-comprehensive`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            text: documentText,
                            chunk_index: 0,
                            total_chunks: 1,
                            options: {
                                analysis_depth: "detailed",
                                provide_examples: true,
                                include_recommendations: true,
                                pharmaceutical_focus: true
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Analysis failed: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const issues = result.suggestions || [];

                    // Display results
                    displayAnalysisResults(issues, result.metadata);
                    
                    updateStatus(`Analysis complete: ${issues.length} issues found`, 'complete');
                });

            } catch (error) {
                console.error('Analysis error:', error);
                updateStatus(`Analysis failed: ${error.message}`, 'error');
                showEmptyState();
            } finally {
                // Reset button
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analyze';
            }
        }

        // Display analysis results
        function displayAnalysisResults(issues, metadata) {
            currentIssues = issues;
            
            if (issues.length === 0) {
                showEmptyState();
                hideNavigation();
                return;
            }

            // Update navigation
            updateNavigation(issues);
            showNavigation();
            
            // Display cards
            displayCards(issues);
        }

        // Update navigation counters
        function updateNavigation(issues) {
            const counts = { critical: 0, high: 0, medium: 0, low: 0 };
            
            issues.forEach(issue => {
                if (counts.hasOwnProperty(issue.severity)) {
                    counts[issue.severity]++;
                }
            });

            document.getElementById('totalIssues').textContent = `${issues.length} issues found`;
            document.getElementById('criticalCount').textContent = counts.critical + counts.high;
            document.getElementById('mediumCount').textContent = counts.medium;
            document.getElementById('lowCount').textContent = counts.low;
        }

        // Display cards in Grammarly style
        function displayCards(issues) {
            const cardsList = document.getElementById('cardsList');
            
            cardsList.innerHTML = issues.map((issue, index) => `
                <div class="card-wrapper">
                    <div class="full-card ${index === maximizedCard ? 'maximized' : 'minimized'}" onclick="toggleCard(${index})">
                        <div class="card-logo ${issue.severity}">
                            ${getSeverityIcon(issue.severity)}
                        </div>
                        
                        <div class="report-list">
                            ${issue.text ? `<span class="item-original">${issue.text.substring(0, 100)}${issue.text.length > 100 ? '...' : ''}</span>` : ''}
                            <span class="item-insert" onclick="highlightAndScrollToIssue('${issue.id}', event)">${issue.suggestion.substring(0, 100)}${issue.suggestion.length > 100 ? '...' : ''}</span>
                        </div>
                        
                        ${index === maximizedCard ? `
                            <div class="full-sentence-background">
                                <strong>Pharmaceutical Recommendation:</strong><br>
                                ${issue.suggestion}
                                ${issue.rationale ? `<br><br><strong>Clinical Impact:</strong> ${issue.rationale}` : ''}
                                ${issue.regulatory_source ? `<br><br>ðŸ“‹ <strong>Regulatory Reference:</strong> ${issue.regulatory_source}` : ''}
                            </div>
                            
                            <div class="card-footer">
                                <button class="card-footer-btn primary" onclick="highlightAndScrollToIssue('${issue.id}', event)">
                                    Locate in Document
                                </button>
                                <button class="card-footer-btn" onclick="dismissIssue(${index}, event)">
                                    Dismiss
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Toggle card maximized/minimized state
        function toggleCard(index) {
            maximizedCard = maximizedCard === index ? null : index;
            displayCards(currentIssues);
        }

        // Dismiss issue
        function dismissIssue(index, event) {
            event.stopPropagation();
            currentIssues.splice(index, 1);
            if (maximizedCard === index) {
                maximizedCard = null;
            } else if (maximizedCard > index) {
                maximizedCard--;
            }
            displayAnalysisResults(currentIssues, null);
        }

        // Get severity icon
        function getSeverityIcon(severity) {
            switch (severity) {
                case 'critical': return '!';
                case 'high': return '!';
                case 'medium': return 'â–³';
                case 'low': return 'â—‹';
                default: return '?';
            }
        }

        // Highlight and scroll to issue in document
        async function highlightAndScrollToIssue(issueId, event) {
            if (event) event.stopPropagation();
            
            try {
                await Word.run(async (context) => {
                    const issue = currentIssues.find(i => i.id === issueId);
                    if (!issue || !issue.text) return;

                    // Clear existing highlights first
                    const allRanges = context.document.body.search("*", {matchWildcards: true});
                    context.load(allRanges, 'items');
                    await context.sync();
                    
                    allRanges.items.forEach(range => {
                        range.font.highlightColor = null;
                    });
                    
                    // Search for the issue text
                    let searchText = issue.text.substring(0, 100).trim();
                    let searchResults = context.document.body.search(searchText);
                    context.load(searchResults, 'items');
                    await context.sync();

                    // If not found, try shorter text
                    if (searchResults.items.length === 0 && searchText.length > 30) {
                        searchText = issue.text.substring(0, 30).trim();
                        searchResults = context.document.body.search(searchText);
                        context.load(searchResults, 'items');
                        await context.sync();
                    }

                    if (searchResults.items.length > 0) {
                        const firstResult = searchResults.items[0];
                        
                        // Highlight with severity color
                        firstResult.font.highlightColor = getSeverityColor(issue.severity);
                        
                        // Select and scroll to the text
                        firstResult.select("Select");
                        
                        console.log(`âœ… Highlighted and scrolled to ${issue.severity} issue`);
                    } else {
                        console.warn(`âš ï¸ Could not find text in document: ${searchText}`);
                        updateStatus(`Could not locate text in document`, 'error');
                        setTimeout(() => updateStatus('Analysis complete', 'complete'), 3000);
                    }

                    await context.sync();
                });
            } catch (error) {
                console.error('Highlighting error:', error);
                updateStatus(`Error highlighting text: ${error.message}`, 'error');
            }
        }

        // Get color for severity
        function getSeverityColor(severity) {
            switch (severity) {
                case 'critical': return '#ea1537';
                case 'high': return '#ea1537';
                case 'medium': return '#f59e0b';
                case 'low': return '#8189a9';
                default: return '#11a683';
            }
        }

        // Update status indicator
        function updateStatus(message, type) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusText.innerHTML = message;
            statusIndicator.className = `status-indicator ${type}`;
            statusIndicator.classList.remove('hidden');
        }

        // Show/hide navigation
        function showNavigation() {
            document.getElementById('navigationContainer').classList.remove('hidden');
        }

        function hideNavigation() {
            document.getElementById('navigationContainer').classList.add('hidden');
        }

        // Show/hide empty state
        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('cardsList').innerHTML = '';
        }

        function hideEmptyState() {
            document.getElementById('emptyState').classList.add('hidden');
        }
    </script>
</body>
</html>