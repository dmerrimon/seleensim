{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Telemetry Event Schema",
  "description": "Schema for telemetry events logged by the Ilana Protocol Intelligence API",
  "type": "object",
  "properties": {
    "request_id": {
      "type": "string",
      "description": "Unique identifier for the request",
      "pattern": "^[a-f0-9\\-]{8,}$"
    },
    "user_id_hash": {
      "type": "string",
      "description": "Hash of user identifier for privacy",
      "pattern": "^[a-f0-9]{32,}$"
    },
    "doc_id_hash": {
      "type": ["string", "null"],
      "description": "Hash of document identifier",
      "pattern": "^[a-f0-9]{32,}$"
    },
    "analyze_mode": {
      "type": "string",
      "enum": ["selection", "document_truncated", "document_chunked", "ta_enhanced", "optimize_selection", "selection_only"],
      "description": "Type of analysis performed"
    },
    "model_path": {
      "type": "string",
      "description": "Model/pipeline path used",
      "enum": [
        "simple_inproc",
        "simple_http", 
        "hybrid_inproc",
        "hybrid_http",
        "legacy_inproc",
        "legacy_http",
        "ta_on_demand",
        "optimize_selection",
        "shadow_worker",
        "dispatch"
      ]
    },
    "prompt_hash": {
      "type": ["string", "null"],
      "description": "Hash of the prompt/input text for deduplication",
      "pattern": "^[a-f0-9]{32,}$"
    },
    "latency_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Request latency in milliseconds"
    },
    "parse_success": {
      "type": "boolean",
      "description": "Whether the response was successfully parsed"
    },
    "suggestion_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of suggestions generated"
    },
    "error_message": {
      "type": ["string", "null"],
      "description": "Error message if request failed"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of the event"
    },
    "event_type": {
      "type": "string",
      "enum": ["start", "success", "error"],
      "description": "Type of telemetry event"
    },
    "metadata": {
      "type": ["object", "null"],
      "description": "Additional metadata for the event",
      "properties": {
        "text_length": {"type": "integer"},
        "response_size": {"type": "integer"},
        "azure_model": {"type": "string"},
        "ta_detected": {"type": "string"},
        "confidence_score": {"type": "number"},
        "rate_limited": {"type": "boolean"},
        "shadow_triggered": {"type": "boolean"},
        "analysis_mode": {"type": "string"},
        "rag_async_enabled": {"type": "boolean"},
        "ta_on_demand_enabled": {"type": "boolean"},
        "shadow_worker_enabled": {"type": "boolean"},
        "shadow_trigger_threshold": {"type": "number"},
        "chunking_enabled": {"type": "boolean"},
        "chunk_max_chars": {"type": "integer"},
        "chunk_overlap": {"type": "integer"},
        "exemplars_used": {"type": "integer"},
        "guidelines_applied": {"type": "integer"},
        "custom_metadata": {"type": "string"}
      }
    }
  },
  "required": [
    "request_id",
    "user_id_hash", 
    "analyze_mode",
    "model_path",
    "latency_ms",
    "parse_success",
    "suggestion_count",
    "timestamp",
    "event_type"
  ],
  "additionalProperties": false
}