{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Telemetry Event Schema",
  "description": "Schema for telemetry events logged by the Ilana Protocol Intelligence API",
  "type": "object",
  "properties": {
    "request_id": {
      "type": "string",
      "description": "Unique identifier for the request",
      "pattern": "^[a-f0-9\\-]{8,}$"
    },
    "user_id_hash": {
      "type": "string",
      "description": "Hash of user identifier for privacy",
      "pattern": "^[a-f0-9]{32,}$"
    },
    "doc_id_hash": {
      "type": ["string", "null"],
      "description": "Hash of document identifier",
      "pattern": "^[a-f0-9]{32,}$"
    },
    "analyze_mode": {
      "type": "string",
      "enum": ["selection", "document_truncated", "document_chunked", "ta_enhanced", "optimize_selection", "selection_only"],
      "description": "Type of analysis performed"
    },
    "model_path": {
      "type": "string",
      "description": "Model/pipeline path used",
      "enum": [
        "simple_inproc",
        "simple_http", 
        "hybrid_inproc",
        "hybrid_http",
        "legacy_inproc",
        "legacy_http",
        "ta_on_demand",
        "optimize_selection",
        "shadow_worker",
        "dispatch"
      ]
    },
    "prompt_hash": {
      "type": ["string", "null"],
      "description": "Hash of the prompt/input text for deduplication",
      "pattern": "^[a-f0-9]{32,}$"
    },
    "latency_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Request latency in milliseconds"
    },
    "parse_success": {
      "type": "boolean",
      "description": "Whether the response was successfully parsed"
    },
    "suggestion_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of suggestions generated"
    },
    "error_message": {
      "type": ["string", "null"],
      "description": "Error message if request failed"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of the event"
    },
    "event_type": {
      "type": "string",
      "enum": [
        "start",
        "success",
        "error",
        "suggestion_accepted",
        "suggestion_undone",
        "rl_feedback_sent",
        "rl_feedback_failed",
        "reinforcement_sent",
        "reinforcement_failed"
      ],
      "description": "Type of telemetry event"
    },
    "suggestion_id": {
      "type": "string",
      "description": "Unique identifier for a suggestion (used in accept/undo events)"
    },
    "accepted_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when suggestion was accepted"
    },
    "undone_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when suggestion was undone"
    },
    "time_to_undo_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Time elapsed between accept and undo in milliseconds"
    },
    "original_text_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of original text (PHI-protected)"
    },
    "improved_text_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of improved text (PHI-protected)"
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence score of the suggestion"
    },
    "severity": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "description": "Severity level of the suggestion"
    },
    "suggestion_type": {
      "type": "string",
      "description": "Type of suggestion (e.g., medical_terminology, compliance, clarity)"
    },
    "ta": {
      "type": "string",
      "description": "Therapeutic area (e.g., general_medicine, oncology, cardiology)"
    },
    "phase": {
      "type": "string",
      "enum": ["development", "staging", "production"],
      "description": "Deployment phase"
    },
    "analysis_mode": {
      "type": "string",
      "enum": ["simple", "comprehensive", "optimize_selection"],
      "description": "Analysis mode used for the suggestion"
    },
    "action": {
      "type": "string",
      "enum": ["accept", "undo"],
      "description": "Action taken by user (for RL feedback events)"
    },
    "reason": {
      "type": "string",
      "description": "Reason for action (e.g., user_undo)"
    },
    "metadata": {
      "type": ["object", "null"],
      "description": "Additional metadata for the event",
      "properties": {
        "text_length": {"type": "integer"},
        "response_size": {"type": "integer"},
        "azure_model": {"type": "string"},
        "ta_detected": {"type": "string"},
        "confidence_score": {"type": "number"},
        "rate_limited": {"type": "boolean"},
        "shadow_triggered": {"type": "boolean"},
        "analysis_mode": {"type": "string"},
        "rag_async_enabled": {"type": "boolean"},
        "ta_on_demand_enabled": {"type": "boolean"},
        "shadow_worker_enabled": {"type": "boolean"},
        "shadow_trigger_threshold": {"type": "number"},
        "chunking_enabled": {"type": "boolean"},
        "chunk_max_chars": {"type": "integer"},
        "chunk_overlap": {"type": "integer"},
        "exemplars_used": {"type": "integer"},
        "guidelines_applied": {"type": "integer"},
        "custom_metadata": {"type": "string"}
      }
    }
  },
  "required": [
    "timestamp",
    "event_type"
  ],
  "additionalProperties": true,
  "oneOf": [
    {
      "description": "Analysis events (start/success/error)",
      "properties": {
        "event_type": {"enum": ["start", "success", "error"]}
      },
      "required": ["request_id", "user_id_hash", "analyze_mode", "model_path", "latency_ms", "parse_success", "suggestion_count"]
    },
    {
      "description": "Suggestion accepted event",
      "properties": {
        "event_type": {"const": "suggestion_accepted"}
      },
      "required": ["suggestion_id", "request_id", "user_id_hash", "ta", "phase", "model_path", "latency_ms", "accepted_at", "original_text_hash", "improved_text_hash"]
    },
    {
      "description": "Suggestion undone event",
      "properties": {
        "event_type": {"const": "suggestion_undone"}
      },
      "required": ["suggestion_id", "request_id", "user_id_hash", "ta", "phase", "undone_at", "time_to_undo_ms", "original_text_hash", "improved_text_hash"]
    },
    {
      "description": "RL feedback sent event",
      "properties": {
        "event_type": {"const": "rl_feedback_sent"}
      },
      "required": ["suggestion_id", "action"]
    },
    {
      "description": "RL feedback failed event",
      "properties": {
        "event_type": {"const": "rl_feedback_failed"}
      },
      "required": ["suggestion_id", "action"]
    },
    {
      "description": "Reinforcement sent event",
      "properties": {
        "event_type": {"const": "reinforcement_sent"}
      },
      "required": ["suggestion_id", "action"]
    },
    {
      "description": "Reinforcement failed event",
      "properties": {
        "event_type": {"const": "reinforcement_failed"}
      },
      "required": ["suggestion_id", "action"]
    }
  ]
}